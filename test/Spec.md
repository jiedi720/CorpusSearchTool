# 字幕语料库检索工具需求规格说明书

## 项目概述
开发一个基于 Python 的字幕语料库检索工具，能够输入某个单词或单词列表，在单个或多个字幕文件中查找该输入单词或列表里所有单词出现的台词，输出对应的完整台词、出现在哪一集的时间轴等信息。同时支持对Word文档、PDF文档、TXT文档、MD文档等多种文档格式进行检索。

## 功能模块说明

### 1. GUI界面模块 (`gui/` 目录)
- 使用 PyQt5 实现所有界面布局、组件样式及窗口初始化代码
- 优化用户视觉体验，消除窗口启动时的"视觉闪烁"现象
- 通过预先计算坐标并利用窗口撤回（Withdraw）机制，实现优雅的居中加载
- 实现现代化界面设计，包括标签、输入框、按钮、表格等组件
- 提供友好的用户交互反馈
- **搜索结果表格优化**：
  - 支持列宽设置保存和恢复
  - 时间轴列：80像素，绿色字体
  - 行号列：60像素，蓝色字体
  - 出处和文件名列：最小宽度150像素，可自由调整
  - 表头高度：30像素
  - 支持多行文本自动换行，行高自适应内容
  - 单行单元格文字与边缘有5像素内边距
  - 关键词高亮显示（黄色加粗）
- **变体表生成功能**：
  - 新增 `lemmalist_btn` 按钮（带 start-up 图标）
  - 使用 kiwipiepy 进行形态分析，自动识别词性
  - 动词/形容词：生成所有可能的变体形式（28种常见变体）
  - 名词/副词：仅显示原始关键词
  - 显示关键词、词性、词典形和完整变体列表
  - 支持不规则活用、敬语形式、否定形式等
- **停止搜索功能**：
  - 新增 `stop_search_btn` 按钮，支持中断正在进行的搜索操作

### 2. 功能算法模块 (`function/` 目录)
- 实现程序功能的底层算法
- 负责字幕文件解析、文档文件解析、关键词检索、结果匹配等核心逻辑
- 支持多种字幕格式（SRT, ASS, VTT等）
- 支持多种文档格式（Word, PDF, TXT, MD等）
- 实现高效的文本搜索算法
- 提供结果排序和过滤功能

### 3. 主程序入口 (`CorpusSearchTool.py`)
- 位于根目录，仅作为程序启动入口
- 负责挂载 gui 模块
- 初始化应用程序配置
- 处理命令行参数（如果需要）

### 4. 配置管理模块
- 实现"若未指定输出目录则默认同源"的逻辑
- 程序关闭时将当前的输入与输出路径自动持久化保存至 `CorpusSearchTool.ini` 配置文件中
- 程序启动时优先读取该 `CorpusSearchTool.ini` 文件，恢复上一次运行时的目录设置
- 管理用户偏好设置

### 5. 文件选择模块
- 提供多种便捷的文件选择方式
- 增加拖拽选择的交互方式，提升用户体验和操作效率
- 同时支持传统的点击选择和现代的拖放操作
- 支持单个和多个文件选择
- 支持文件夹批量处理

### 6. 搜索引擎模块
- 实现精确匹配和模糊匹配功能
- 支持大小写敏感/不敏感选项
- 支持韩语/英语变形匹配功能（当输入为韩语或英语的单词原型时，也一并找不同时态，不同变形的形态）
- 支持正则表达式搜索
- 提供搜索历史记录功能
- **韩语高级检索系统**：
  - 使用kiwipiepy进行形态分析，判定词性（名词/副词/动词/形容词）
  - 动词/形容词自动还原为词典形，无论输入时的具体活用形态
  - 动词/形容词：动态识别并覆盖所有与词典形对应的实际出现形式
  - 名词/副词：仅包含原始关键词本身（严格匹配）
  - 生成完整的搜索记录，包含：
    - 用户输入的原始关键词
    - 系统判定的词典形
    - 基于词典形实际命中的所有变体形式列表
    - 最终命中的句子列表
  - **变体生成优化**：
    - 使用 kiwipiepy 的 `join()` 方法生成变体，替代手动规则
    - 基于训练的语言模型，自动处理元音和谐规则
    - 支持不规则活用（如 `하다` → `해` 而不是 `하아`）
    - 支持敬语形式（`시`, `셔요`, `셨어요`）
    - 支持否定形式（`지 않다`, `지 않아`, `지 않아요`）
    - 自动修正 kiwipiepy 的常见分析错误（如 `이루다` 被误判为副词）
    - **缩约形/非缩约形并行生成**：
      - 同时生成缩约形和非缩约形，提升搜索覆盖率
      - 缩约形：使用 `kiwi.join(morphs)` 生成符合语言习惯的形式（如 `이뤄`）
      - 非缩约形：直接拼接词干和词尾生成完整展开形式（如 `이루어`）
      - 自动去重，确保变体列表无重复
      - 变体数量从 28 个增加到约 34-44 个
      - 适用于所有存在缩约/非缩约并存的韩语词形变化
  - **生成的变体类型**：
    - 终结词尾：`다`, `어`, `어요`, `어서`
    - 过去时：`었`, `었어`, `었어요`, `었고`
    - 连接词尾：`고`, `면`, `자`
    - 名词化：`음`, `기`
    - 冠词形：`는`, `은`, `을`
    - 将来时：`겠다`, `겠어`, `겠어요`
    - 否定：`지 않다`, `지 않아`, `지 않아요`
    - 敬语：`셔요`, `셨어요`
- **搜索历史存储**：
  - 从JSON格式改为Markdown格式
  - 简化格式，移除"区分大小写"和"模糊匹配"字段
  - 只保留关键信息：关键词、时间、输入路径、输出路径、结果数量、关键词类型和正则表达式设置
- **搜索流程优化**：
  - 点击搜索按钮时，对于韩语语料库，先执行变体表生成功能
  - 使用 kiwipiepy 分析关键词，识别词性和词典形
  - 更新 `korean_lemma_display` 显示 `[词性]：词典形`
  - 生成完整的变体列表（28种常见变体）
  - 更新 `korean_lemmalist_display` 显示变体列表（逗号分隔）
  - 使用生成的变体列表进行文件搜索，确保匹配所有可能的变体形式
  - 对于英语语料库，保持原有搜索逻辑不变
- **变体表生成功能**：
  - 独立的 `lemmalist_btn` 按钮，用于生成变体表
  - 与搜索按钮使用相同的格式化方法 `format_lemma_display()`
  - 显示格式统一：`[词性]：词典形`
  - 变体列表显示格式：逗号分隔的变体列表
  - 支持在搜索前预览词典形和变体列表

### 7. 结果展示模块
- 以表格形式展示搜索结果
- 显示时间轴、行号、出处、原始文本和匹配的关键词
- 支持结果导出功能（CSV, TXT等格式）
- 提供结果筛选和排序功能
- **表格列配置**：
  - 时间轴列：80像素宽，绿色字体，固定宽度
  - 行号列：60像素宽，蓝色字体，固定宽度
  - 出处列：最小宽度150像素，可自由调整
  - 文件名列：最小宽度150像素，可自由调整
  - 对应台词列：自适应内容，可自由调整
- **列宽持久化**：
  - 程序关闭时自动保存列宽设置到配置文件
  - 程序启动时自动恢复上次保存的列宽设置
- **显示优化**：
  - 多行文本自动换行，行高自适应内容
  - 关键词高亮显示（黄色加粗）
  - 表格行高自动调整，防止文字重叠

### 8. 打包部署模块
- 使用 spec 技能创建程序的 .spec 文件
- 确保生成的 .exe 文件标题栏正常显示图标
- 程序运行后能准确识别并读取同级目录下的配置文件
- 优化打包体积和启动速度

## 技术架构
- 语言：Python 3.x
- GUI框架：PyQt5
- 形态分析：kiwipiepy（韩语）
- 配置文件格式：INI
- 文件格式支持：字幕文件（SRT, ASS, VTT等）和文档文件（Word, PDF, TXT, MD等）

## 用户界面要求
- 支持多文件选择
- 支持关键词输入框
- 显示检索结果表格
- 包含时间轴和行号信息
- 支持导出功能
- 现代化的UI设计
- 响应式布局
- 支持英语和韩语双标签页切换
- 提供搜索历史记录查看功能
- 提供变体表生成功能
- 支持停止搜索功能
- 支持拖拽文件选择

## 性能要求
- 快速检索大量字幕文件和文档
- 内存使用合理
- 响应迅速
- 支持后台处理大文件

## 可扩展性要求
- 采用严格的文件结构解耦模式
- 模块间低耦合高内聚
- 便于后续功能扩展
- 支持插件化功能添加

## 最新更新 (2026-01-25)

### 变体表生成功能
- 新增 `lemmalist_btn` 按钮，用于生成韩语单词的变体表
- 使用 kiwipiepy 的 `join()` 方法生成变体，替代手动规则
- 自动识别词性（动词/形容词/名词/副词）
- 生成 28 种常见的变体形式，包括：
  - 终结词尾、过去时、连接词尾
  - 名词化、冠词形、将来时
  - 否定形式、敬语形式
- 智能处理元音和谐规则和不规则活用
- 自动修正 kiwipiepy 的常见分析错误

### 搜索结果表格优化
- 列宽设置支持保存和恢复
- 时间轴列：80像素，绿色字体
- 行号列：60像素，蓝色字体
- 出处和文件名列：最小宽度150像素，可自由调整
- 表头高度：30像素
- 多行文本自动换行，行高自适应内容
- 关键词高亮显示（黄色加粗）

### 停止搜索功能
- 新增 `stop_search_btn` 按钮
- 支持中断正在进行的搜索操作
- 提升用户体验，避免长时间等待

### 韩语变体生成优化
- 从手动规则改为使用 kiwipiepy 的 `join()` 方法
- 基于训练的语言模型，更准确、更全面
- 自动处理复杂情况（如 `이루다` → `이뤄` 而不是 `이루아`）
- 支持不规则活用（如 `하다` → `해`）
- 支持敬语和否定形式

### 搜索流程优化
- 点击搜索按钮时，对于韩语语料库自动执行变体生成
- 先使用 kiwipiepy 分析关键词，识别词性和词典形
- 更新 `korean_lemma_display` 显示 `[词性]：词典形`
- 生成完整的变体列表并显示在 `korean_lemmalist_display`
- 使用生成的变体列表进行文件搜索，确保匹配所有变体
- 搜索按钮和 `lemmalist_btn` 使用相同的格式化方法
- 统一显示格式：`[词性]：词典形`
- 变体列表以逗号分隔显示

### 显示格式优化
- `korean_lemma_display` 显示格式从 `关键词 (词性) → 词典形` 改为 `[词性]：词典形`
- `korean_lemmalist_display` 左右 padding 从 15px 改为 10px，更对称和谐
- 词典形显示使用共享方法 `format_lemma_display()`，确保一致性

### 搜索结果表格行高优化
- **问题**：表格行高过大，文字与表格上下边缘间隙较大
- **解决方案**：
  - 将默认行高从 30 像素减小到 18 像素
  - 同时设置最小行高和最大行高为 18 像素，强制固定行高
  - 字体大小从 11pt 减小到 9pt
  - `sizeHint()` 方法返回的高度设置为 18 像素
  - 添加 `doc.setDocumentMargin(0)` 移除文档边距
- **关键代码**：
  ```python
  self.result_table.verticalHeader().setDefaultSectionSize(18)
  self.result_table.verticalHeader().setMinimumSectionSize(18)
  self.result_table.verticalHeader().setMaximumSectionSize(18)
  ```
- **效果**：行高固定为 18 像素，表格更紧凑，显示更多内容

### 搜索结果表格文字居中修复
- **问题**：表格中的文字往上偏，没有垂直居中
- **根本原因**：之前使用固定偏移量 `y = option.rect.top() + 8` 来定位文字，这种方法只适用于固定行高的情况。当行高动态变化时，固定偏移量无法保证文字居中
- **解决方案**：使用动态计算的方式确定 y 坐标
  ```python
  y = option.rect.top() + (available_height - int(text_height)) / 2
  ```
- **关键点**：
  1. 获取单元格实际高度：`option.rect.height()`
  2. 获取文字实际高度：`doc.size().height()`
  3. 计算垂直居中位置：`(单元格高度 - 文字高度) / 2`
  4. 加上单元格顶部偏移：`option.rect.top()`
- **为什么这样可以工作**：
  - 无论单元格高度是 30px（单行）还是更高（多行），都能正确计算居中位置
  - 文字高度由 `QTextDocument` 自动计算，考虑了字体大小、行高等因素
  - 公式 `(H_cell - H_text) / 2` 确保文字在单元格内垂直居中
- **其他相关设置**：
  - 左右边距：各 8px，通过 `padding_left` 和 `padding_right` 控制
  - 上下边距：通过 `sizeHint` 方法中的 `row_height = text_height + 16` 实现
  - 行高自适应：通过 `sizeHint` 方法根据文本内容动态计算行高
  - 列宽变化时自动调整行高：通过 `on_column_resized` 和 `update_row_heights` 方法实现

### 列宽变化时自动调整行高修复
- **问题**：拖拽列宽时，文字换行了但行高没有自动调整
- **根本原因**：`update_row_heights` 方法使用了 `viewOptions()` 作为 `sizeHint` 的参数，但这个方法返回的选项不包含正确的单元格矩形信息（宽度），导致 `sizeHint` 无法正确计算文本是否换行
- **解决方案**：创建正确的 `QStyleOptionViewItem` 对象，包含准确的单元格矩形信息
  ```python
  option = QStyleOptionViewItem()
  option.initFrom(self.result_table)
  option.rect = self.result_table.visualRect(index)
  size_hint = self.result_table.itemDelegate(index).sizeHint(option, index)
  ```
- **关键点**：
  1. 创建 `QStyleOptionViewItem` 对象
  2. 使用 `initFrom()` 初始化选项，继承表格的样式设置
  3. 使用 `visualRect(index)` 获取单元格的实际矩形（包含正确的宽度）
  4. 将正确的 `option` 传递给 `sizeHint` 方法
- **为什么这样可以工作**：
  - `visualRect(index)` 返回单元格在视口中的实际矩形，包含当前列宽
  - `sizeHint` 方法使用 `option.rect.width()` 来设置文本宽度，判断是否需要换行
  - 当列宽变化时，`visualRect(index)` 返回的矩形宽度也会变化，从而触发正确的行高计算
- **其他相关设置**：
  - 使用定时器延迟执行（100ms），避免频繁更新影响性能
  - 遍历所有行，重新计算每行的高度并设置
  - 只更新对应台词列（索引2）的高度，因为这是唯一可能换行的列

## 最新更新 (2026-01-26)

### 韩语变体生成缩约形/非缩约形并行生成
- **问题**：原有代码使用 kiwipiepy 的 `join()` 方法生成韩语动词/形容词的变体，但该方法基于训练的语言模型会自动应用韩语的缩约规则，导致：
  - 只生成缩约形（如 `이뤄`）
  - 遗漏非缩约形（如 `이루어`）
  - 影响搜索覆盖率和语言学正确性
- **根本原因**：kiwipiepy 的 `join()` 方法模拟自然语言使用习惯，优先生成常见的缩约形式，不符合语言学研究和语料库检索的完整性要求
- **解决方案**：在 `function/search_engine_kor.py` 的 `_generate_korean_variants` 方法中实现并行生成机制：
  1. **保留缩约形生成**：继续使用 `kiwi.join(morphs)` 生成符合语言习惯的缩约形式
  2. **添加非缩约形生成**：直接拼接词干和词尾（`base + ''.join([e[0] for e in endings])`），生成完整的展开形式
  3. **自动去重**：确保变体列表中没有重复项
- **关键代码**：
  ```python
  # 使用kiwipiepy的join方法生成变体（会自动应用缩约规则）
  variant = self.kiwi.join(morphs)
  if variant and variant not in variants:
      variants.append(variant)

  # 生成非缩约形：直接拼接词干和词尾，不使用join
  expanded_variant = base + ''.join([e[0] for e in endings])
  if expanded_variant and expanded_variant not in variants:
      variants.append(expanded_variant)
  ```
- **修复效果**：
  - **变体数量**：从 28 个增加到约 34-44 个（取决于具体词汇）
  - **覆盖率提升**：同时匹配缩约形和非缩约形
  - **向后兼容**：不影响现有的缩约形搜索功能
- **示例对比**：
  - `이루다`：原生成 `이뤄`，现在同时生成 `이뤄` 和 `이루어`
  - `하다`：原生成 `해`，现在同时生成 `해` 和 `하어`
  - `크다`：原生成 `커`，现在同时生成 `커` 和 `크어`
  - `빠르다`：原生成 `빨라`，现在同时生成 `빨라` 和 `빠르어`
- **测试验证**：
  - ✅ 缩约形和非缩约形成对出现
  - ✅ 变体数量在合理范围内（30-50个）
  - ✅ 无重复变体
  - ✅ 搜索功能正常工作
  - ✅ 不破坏现有功能
- **优势**：
  1. 提升搜索覆盖率：同时匹配缩约形和非缩约形
  2. 语言学正确性：保留完整的词形变化信息
  3. 向后兼容：不影响现有的缩约形搜索功能
- **适用范围**：适用于所有存在缩约/非缩约并存的韩语词形变化，包括：
  - `ㅡ` 缩约（如 `이루다` → `이뤄` / `이루어`）
  - `ㅏ` 缩约（如 `하다` → `해` / `하어`）
  - `르` 不规则缩约（如 `빠르다` → `빨라` / `빠르어`）
  - `ㅂ` 不规则缩约（如 `돕다` → `도와` / `돕어`）
  - 以及其他所有可能的缩约形式